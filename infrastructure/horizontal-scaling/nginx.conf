events {
    worker_connections 1024;
}

http {
    upstream like_service_backend {
        # Use round-robin load balancing (default)
        # Health check parameters:
        # - max_fails: Number of consecutive failures before marking server as down (default: 1)
        # - fail_timeout: Time window for failures and how long server stays marked as unavailable (default: 10s)
        # - backup: Mark server as backup (only used when all primary servers are down)
        # - down: Permanently mark server as unavailable
        server like-service-1:3000 max_fails=3 fail_timeout=10s;
        server like-service-2:3000 max_fails=3 fail_timeout=10s;
        
        # Alternative load balancing algorithms (commented out):
        
        # Weighted round-robin: Distribute traffic based on server weights
        # server like-service-1:3000 weight=3;
        # server like-service-2:3000 weight=1;
        
        # Least connections: Route to server with fewest active connections
        # least_conn;
        # server like-service-1:3000;
        # server like-service-2:3000;
        
        # IP hash: Route based on client IP (sticky sessions)
        # ip_hash;
        # server like-service-1:3000;
        # server like-service-2:3000;
        
        # Generic hash: Route based on custom key (e.g., consistent hashing)
        # hash $request_uri consistent;
        # server like-service-1:3000;
        # server like-service-2:3000;
    }

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://like_service_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Forward the upstream server name to identify which backend instance is responding
            proxy_set_header X-Upstream-Server $upstream_addr;
            # Forward the port that nginx is listening on (external port)
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Health check and connection settings
            # These timeouts affect how quickly nginx detects a backend failure:
            # - proxy_connect_timeout: Time to establish connection (default: 60s)
            #   Lower values = faster detection of unreachable servers
            # - proxy_send_timeout: Time to send request to backend (default: 60s)
            # - proxy_read_timeout: Time to read response from backend (default: 60s)
            proxy_connect_timeout 5s;   # Fast detection of unreachable servers
            proxy_send_timeout 10s;     # Reasonable timeout for sending requests
            proxy_read_timeout 10s;     # Reasonable timeout for reading responses
            
            # Next upstream: If current server fails, try next one immediately
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;      # Try up to 2 servers
            proxy_next_upstream_timeout 10s;  # Total time to try all servers
        }

        # Health check endpoint
        location /health {
            access_log off;
            proxy_pass http://like_service_backend/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Forward the port that nginx is listening on (external port)
            proxy_set_header X-Forwarded-Port $server_port;
            # Add upstream server info to response headers (available after proxy_pass)
            add_header X-Upstream-Server $upstream_addr always;
            add_header Content-Type text/plain;
        }
    }
}
